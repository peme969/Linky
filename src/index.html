<!DOCTYPE html>
<html lang="en"><head>
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
  <link rel="manifest" href="./site.webmanifest">
  <meta name="title" content="Peme969‚Äôs Link Shortener">
  <meta name="description" content="Peme969‚Äôs Personal Link Shortener">
  <meta name="keywords" content="link, shortener, peme969, cloudflare, cloudflare-workers, link-shortener">
  <meta name="robots" content="index, follow">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Link Shortener üîó</title>
  <link rel="stylesheet" href="./style.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { background: #1e1e1e; color: #eee; font-family: sans-serif; padding: 2rem; }
    .tabs { display: flex; margin-bottom: 1rem; }
    .tab {
      cursor: pointer;
      padding: 0.5rem 1rem;
      margin-right: 1rem;
      background: rgba(255,255,255,0.1);
      border-radius: 4px 4px 0 0;
      user-select: none;
    }
    .tab.active { background: #3b82f6; color: #fff; }
    .tab-content { display: none; padding: 1rem; background: #2a2a2a00; border-radius: 0 4px 4px 4px; }
    .tab-content.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.5rem; border: 1px solid #444; text-align: left; }
    .btn { padding: 0.3rem 0.6rem; cursor: pointer; border: none; border-radius: 3px; }
    .btn.delete { color: #f33; background: transparent; }
    .info-box { margin-top: 1rem; font-size: 0.9rem; color: #aaa; }
  </style>
</head>
<body data-new-gr-c-s-check-loaded="14.1247.0" data-gr-ext-installed="">
  <select class="palette-dropdown" id="palette-selector">
    <option value="DarkSky">Dark Sky</option>
    <option value="DeepOcean">DeepOcean</option>
  </select>
  <h1>Peme969's Link Shortener</h1>
  <div class="container">
    <!-- TABS NAV -->
    <div class="tabs">
      <div class="tab active" data-target="#create-tab">Create Link</div>
      <div class="tab" data-target="#manage-tab">Manage Links</div>
    </div>

    <!-- CREATE PANEL -->
    <div id="create-tab" class="tab-content active" style="
    position: relative;
    left: -48px;
">
      <form class="create-form">
        <input id="secret-input" type="text" placeholder="API Key" required="">
        <input id="url-input" type="url" placeholder="URL to shorten" required="">
        <input id="password-input" type="password" placeholder="Password (optional)">
        <input id="slug-input" type="text" placeholder="Custom alias (optional)">
        <input id="expiration-input" type="text" placeholder="YYYY-MM-DD hh:mm AM/PM (optional)">
        <input type="submit" id="create" value="Shorten URL">
      </form>
      <div class="result-container">
        <h3 id="had">API Response:</h3>
        <p id="result">Submit the form to shorten a URL...</p>
      </div>
    </div>

    <!-- MANAGE PANEL -->
    <div id="manage-tab" class="tab-content">
      <div class="manage-inputs" style="
    display: flex;
    flex-direction: column;
    align-content: stretch;
    justify-content: space-evenly;
    align-items: center;
">
        <input id="manage-api-key" type="text" placeholder="API Key" style="
    width: 60%;
">
        <input id="manage-super-secret" type="text" placeholder="Super Secret Key" style="
    width: 60%;
    margin-top: 20px;
">
        <button id="load-links" class="btn">Load My Links</button>
      </div>

      <table id="links-table">
        <thead>
          <tr>
            <th>Redirect URL</th>
            <th>Destination URL</th>
            <th>Public?</th>
            <th>Created At</th>
            <th>Expires At</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      

      <div id="manage-info" class="info-box">
        Enter your keys and click ‚ÄúLoad My Links.‚Äù<br>
        Public links only need API key; private links need both.
      </div>
    </div>
  </div>
  <script>
    $(function() {
      const $submitBtn = $('#create');
      const $expiration = $('#expiration-input');
      const $result = $('#result');
      const expPattern = /^\d{4}-\d{2}-\d{2} \d{2}:\d{2} (AM|PM)$/;
      const origin = window.location.origin;

      function validateExpiration() {
        const val = $expiration.val().trim();
        if (val && !expPattern.test(val)) {
          $result.text('‚ö†Ô∏è Expiration must be YYYY-MM-DD hh:mm AM/PM')
            .addClass('bad').removeClass('good');
          $submitBtn.prop('disabled', true);
          return false;
        }
        $result.text('').removeClass('bad good');
        $submitBtn.prop('disabled', false);
        return true;
      }
      $expiration.on('input', validateExpiration);

      // Create link
      $('.create-form').submit(function(e) {
        e.preventDefault();
        if (!validateExpiration()) return;
        const secret = $('#secret-input').val().trim();
        const urlToShorten = $('#url-input').val().trim();
        const password = $('#password-input').val().trim();
        const slug = $('#slug-input').val().trim();
        const expiration = $expiration.val().trim();
        if (!secret || !urlToShorten) {
          $result.text('‚ö†Ô∏è API Key and URL are required').addClass('bad');
          return;
        }
        $.ajax({
          url: '/api/create',
          type: 'POST',
          headers: {
            'Authorization': 'Bearer ' + secret,
            'Content-Type': 'application/json'
          },
          data: JSON.stringify({ url: urlToShorten, password, slug, expiration }),
          success(res) {
            $result.html(
              `‚úÖ Shortened: <a href="${origin}/${res.slug}" target="_blank">${origin}/${res.slug}</a><br>` +
              `Expires in: ${res.expirationInSeconds}s${res.passwordProtected? '<br>üîí Password protected' : ''}`
            ).addClass('good');
          },
          error(xhr) {
            $result.text('Error: ' + (xhr.responseJSON?.error || xhr.statusText)).addClass('bad');
          }
        });
      });

      // List links
      $('#list').click(function() {
        const secret      = $('#secret-input').val().trim();
        const superSecret = $('#password-input').val().trim();
        if (!secret || !superSecret) {
          $result.text('‚ö†Ô∏è API Key required to list links').addClass('bad');
          return;
        }
        $.ajax({
          url: '/api/links',
          type: 'GET',
          headers: { 
            'Authorization': 'Bearer ' + secret,
            'X-Super-Secret': superSecret
          },
          success(res) {
            $('#links-list').empty();
            res.forEach(item => {
              let line = `<li>
             <a href="${origin}/${item.slug}" target="_blank">${item.slug}</a>
             ‚Üí ${item.url} (${item.metadata.expirationInSeconds}s)
           `;
           if (item.passwordProtected) {
             line += ' üîí';
             if (item.password) {
               line += ` (password: ${item.password})`; 
             }
           }
           line += '</li>';
           $('#links-list').append(line);
            });
            $('.list-container').show();
          },
          error(xhr) {
            $result.text('Error: ' + (xhr.statusText)).addClass('bad');
          }
        });
      });
    });
$(document).ready(function () {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        applyTheme(savedTheme);
    }
});
$('.palette-dropdown').on('change', function () {
    const selectedTheme = $(this).val();
    if (selectedTheme !== localStorage.getItem('theme')) {
        applyTheme(selectedTheme);
        localStorage.setItem('theme', selectedTheme);
    }
});
function applyTheme(theme) {
    if (!themeDict[theme]) return;
    const root = document.documentElement;
    $('.palette-dropdown').val(theme);
    root.style.setProperty('--dynamic-bg', getComputedStyle(root).getPropertyValue(themeDict[theme].bg));
    root.style.setProperty('--dynamic-text', getComputedStyle(root).getPropertyValue(themeDict[theme].text));
    $('body').css({
        'background': 'var(--dynamic-bg)',
        'color': 'var(--dynamic-text)'
    });
    updateTitle(theme);
}
function updateTitle(theme) {
    if (document.title !== themeDict[theme].title) {
        document.title = themeDict[theme].title;
    }
}

        </script>
       
       <script src="./run.js"></script>
       <script>
        $(function() {
    // --- TAB SWITCHING ---
    $('.tab').click(function() {
      const target = $(this).data('target');
      // activate tab button
      $('.tab').removeClass('active');
      $(this).addClass('active');
      // show matching pane
      $('.tab-content').removeClass('active');
      $(target).addClass('active');
    });
  
    // --- CREATE LINK FORM ---
    $('#create-form').submit(async function(e) {
      e.preventDefault();
      const apiKey      = $('#create-api-key').val().trim();
      const url         = $('#create-url').val().trim();
      const expiration  = $('#create-expiration').val().trim();
      const slug        = $('#create-slug').val().trim();
      const password    = $('#create-password').val().trim();
  
      try {
        const res = await $.ajax({
          url: '/api/create',
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + apiKey },
          contentType: 'application/json',
          data: JSON.stringify({ url, expiration, slug, password })
        });
        $('#create-result').text(JSON.stringify(res, null, 2));
      } catch (err) {
        $('#create-result').text('Error: ' + (err.responseJSON?.error || err.statusText));
      }
    });
  
    async function loadLinks() {
    const apiKey   = $('#manage-api-key').val().trim();
    const superKey = $('#manage-super-secret').val().trim();
    const $tbody   = $('#links-table tbody');
    const origin   = window.location.origin;
    $tbody.empty();
    $('#manage-info').text('Loading‚Ä¶');

    try {
      const links = await $.ajax({
        url: '/api/links',
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + apiKey,
          'X-Super-Secret': superKey
        }
      });

      if (!links.length) {
        $('#manage-info').text('No links found.');
        return;
      }

      links.forEach(link => {
        // Construct the short (redirect) URL:
        const redirectUrl = `${origin}/${link.slug}`;

        // Use the raw UTC timestamps for parsing
        const expiresMillis = link.metadata.expiresAtUtc;
        const createdMillis = link.metadata.createdAtUtc;
        const created = isNaN(createdMillis)
          ? 'Invalid date'
        : new Date(createdMillis).toLocaleString();

        const expires = isNaN(expiresMillis)
          ? 'Invalid date'
          : new Date(expiresMillis).toLocaleString();

        $tbody.append(`
          <tr>
            <td><a href="${redirectUrl}" target="_blank">${redirectUrl}</a></td>
            <td><a href="${link.url}" target="_blank">${link.url}</a></td>
            <td>${link.passwordProtected ? 'Private' : 'Public'}</td>
            <td>${created}</td>
            <td>${expires}</td>
            <td>
              <button class="btn delete" data-slug="${link.slug}">
                üóëÔ∏è
              </button>
            </td>
          </tr>
        `);
      });

      $('#manage-info').text(`Loaded ${links.length} link(s).`);
    } catch (err) {
      $('#manage-info').text('Error loading links: ' +
        (err.responseJSON?.error || err.statusText));
    }
  }

  $('#load-links').click(loadLinks);

  // DELETE now calls /api/:slug (not /api/links/:slug)
  $('#links-table').on('click', '.btn.delete', async function() {
    const slug    = $(this).data('slug');
    const apiKey  = $('#manage-api-key').val().trim();
    const superKey= $('#manage-super-secret').val().trim();

    if (!confirm(`Delete link ‚Äú${slug}‚Äù?`)) return;

    try {
      await $.ajax({
        url: `/api/${slug}`,
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + apiKey,
          'X-Super-Secret': superKey
        }
      });
      loadLinks();  // refresh table
    } catch (err) {
      alert('Delete failed: ' + (err.responseJSON?.error || err.statusText));
    }
  });
});
  
       </script>
    
</body>
</html>